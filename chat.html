<!DOCTYPE html>
<html>
<body>
  <h3>Secure Private Chat</h3>

  <p>
    Logged in as <b id="me"></b> —
    <a href="/logout">Logout</a>
  </p>

  <label>Send to:</label>
  <input id="receiver" placeholder="username" />

  <ul id="messages"></ul>

  <form id="form">
    <input id="input" autocomplete="off" />
    <button>Send</button>
  </form>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const me = document.getElementById("me");
    const receiver = document.getElementById("receiver");
    const messages = document.getElementById("messages");
    const form = document.getElementById("form");
    const input = document.getElementById("input");

    fetch("/whoami")
      .then(r => r.json())
      .then(d => (me.textContent = d.user));

    function addMsg(msg) {
      const li = document.createElement("li");
      li.textContent = `${msg.from} ➜ ${msg.to}: ${msg.message}`;
      messages.appendChild(li);
    }

    socket.on("chat-history", list => list.forEach(addMsg));

    socket.on("chat message", addMsg);

    form.addEventListener("submit", e => {
      e.preventDefault();
      if (!input.value || !receiver.value) return;

      socket.emit("private-message", {
        to: receiver.value,
        message: input.value
      });

      input.value = "";
    });
  </script>
</body>
</html>