<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Chat</title>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    body { font-family:Arial; background:#eef1f4; padding:25px; }
    #chatBox { height:360px; overflow-y:auto; background:#fff;
      border:1px solid #ccc; padding:10px; border-radius:8px; }
    .msg { margin-bottom:6px; }
    .time { color:#777; font-size:11px; }
    input { width:75%; padding:9px; }
    button { padding:9px 14px; }
  </style>
</head>

<body>

<h2>Secure Chat</h2>
<p id="me"></p>

<div id="chatBox"></div>

<br>

<input id="msg" placeholder="Type a message..." />
<button onclick="send()">Send</button>

<br><br>
<a href="/logout">Logout</a>

<script>
  const socket = io();
  const chat = document.getElementById("chatBox");
  const msg = document.getElementById("msg");

  let username = "";

  fetch("/whoami")
    .then(r => r.json())
    .then(u => {
      username = u.username;
      document.getElementById("me").textContent =
        "Logged in as: " + username;

      socket.emit("join", username);
    });

  function add(m) {
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML =
      `<b>${m.sender}</b>: ${m.content}
       <span class="time">${m.time}</span>`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  socket.on("history", messages => messages.forEach(add));
  socket.on("message", add);

  function send() {
    if (!msg.value.trim()) return;
    socket.emit("message", msg.value);
    msg.value = "";
  }
</script>

</body>
</html>
