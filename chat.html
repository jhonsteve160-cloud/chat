<!DOCTYPE html>
<html>
<head>
  <title>Chat Room</title>
  <meta charset="UTF-8" />
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family:Arial;background:#f5f5f5;padding:20px; }
    #chat { height:350px; overflow-y:auto; border:1px solid #ccc; background:#fff; padding:10px; }
    #msg { width:75%; padding:8px; }
  </style>
</head>
<body>

<h2>Real-Time Chat</h2>
<p id="user"></p>

<div id="chat"></div>

<br>

<input id="msg" placeholder="Type message..." />
<button onclick="send()">Send</button>

<br><br>
<a href="/logout">Logout</a>

<script>
  const socket = io();

  // username from session via query param fallback
  fetch("/whoami").catch(()=>{})

  const username = new URLSearchParams(window.location.search).get("u")
    || "You";

  document.getElementById("user").textContent =
    "Logged in as: " + username;

  const chat = document.getElementById("chat");

  function add(msg) {
    const div = document.createElement("div");
    div.textContent =
      `[${msg.username}] ${msg.message}`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  // Load past messages
  socket.on("chat_history", messages => {
    messages.forEach(add);
  });

  // Receive new message
  socket.on("new_message", add);

  function send() {
    const box = document.getElementById("msg");
    if (!box.value.trim()) return;

    socket.emit("send_message", {
      username,
      message: box.value
    });

    box.value = "";
  }
</script>

</body>
</html>
