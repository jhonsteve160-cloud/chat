<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width">
<title>Secure Chat</title>

<style>
body { font-family: system-ui; background:#0f172a; color:#e5e7eb; margin:0; }
.container { max-width:900px; margin:auto; padding:16px; }
.card { background:#020617; border-radius:16px; padding:16px; }
input, button, select {
  padding:10px; border-radius:10px; border:none; margin:4px 0;
}
#chat { height:420px; overflow-y:auto; background:#020617; border-radius:12px; padding:10px; }
.msg { padding:8px; margin:4px 0; background:#020617; border:1px solid #1f2937; border-radius:12px; }
.small { opacity:0.6; font-size:12px; }
.typing { font-style:italic; opacity:0.6; }
</style>
</head>

<body>
<div class="container">
<div class="card">

<h2>Secure Chat</h2>

<div id="loginBox">
  <input id="username" placeholder="username">
  <input id="password" type="password" placeholder="password">
  <button onclick="login()">Login</button>
</div>

<div id="chatUI" style="display:none">

  <div>
    <span>Logged in as <b id="me"></b></span>
  </div>

  <select id="room">
    <option value="global">Global Room</option>
  </select>

  <div id="chat"></div>
  <div class="typing" id="typing"></div>

  <input id="msg" placeholder="Type message…">
  <button onclick="sendMessage()">Send</button>
</div>

</div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io();
let user = null;

function login(){
  fetch("/login", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      username: username.value,
      password: password.value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.error){ alert(d.error); return; }

    user = d;
    me.textContent = d.username;

    loginBox.style.display="none";
    chatUI.style.display="block";

    socket.emit("joinRoom","global");
    loadMessages();
  });
}

function loadMessages(){
  fetch("/messages").then(r=>r.json()).then(msgs=>{
    msgs.forEach(renderMessage);
  });
}

function renderMessage(m){
  const div = document.createElement("div");
  div.className="msg";
  div.innerHTML = `
    <b>${m.from}</b> → <b>${m.room || "global"}</b><br>
    ${m.text}<br>
    <span class="small">${new Date(m.timestamp).toLocaleString()}</span>
  `;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

msg.addEventListener("input", ()=>{
  socket.emit("typing", room.value, user.username);
});

socket.on("typing", u=>{
  typing.textContent = `${u} is typing…`;
  setTimeout(()=> typing.textContent="", 1200);
});

socket.on("message", renderMessage);

function sendMessage(){
  const payload = {
    from: user.username,
    room: room.value === "global" ? null : room.value,
    text: msg.value.trim()
  };

  if(!payload.text) return;

  socket.emit("message", payload);
  msg.value="";
}
</script>

</body>
</html>
