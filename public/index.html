<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<title>Secure Chat</title>
<style>
:root {
  --bg: #0f172a;
  --card-bg: #1e293b;
  --text: #f8fafc;
  --border: #334155;
  --primary: #3b82f6;
  --primary-hover: #2563eb;
  --msg-bg: #334155;
}
body { margin:0; font-family: Inter, system-ui; background: var(--bg); color: var(--text); }
.container { max-width:960px; margin:auto; padding:10px; }
.card { background: var(--card-bg); border-radius:18px; padding:15px; box-shadow:0 10px 30px rgba(0,0,0,.3); border: 1px solid var(--border); }
input,button,select,textarea{
  padding:12px; border-radius:12px; border:1px solid var(--border);
  width:100%; margin:5px 0; background: #0f172a; color: white; box-sizing: border-box;
}
button { background: var(--primary); border: none; cursor: pointer; font-weight: 600; transition: background 0.2s; }
button:hover { background: var(--primary-hover); }
#chat{height:400px; overflow-y:auto; padding:10px; background: #0f172a; border-radius:12px; border:1px solid var(--border); margin-bottom: 10px;}
.msg{padding:10px; margin:8px 0; border-radius:12px; background: var(--msg-bg); border: 1px solid var(--border); word-break: break-word;}
.small{font-size:12px; opacity:.6}
.row{display:flex; gap:8px; align-items: center;}
.badge{padding:4px 10px; border-radius:10px; background: var(--primary); font-size: 12px;}
#online span{margin-right:10px; font-size: 14px; opacity: 0.8;}
textarea#msg { height: 60px; resize: none; }
.modal { background: rgba(0,0,0,0.8); position: fixed; top:0; left:0; width:100%; height:100%; display:none; justify-content:center; align-items:center; z-index: 100;}
.modal-content { background: var(--card-bg); padding: 25px; border-radius: 18px; width: 100%; max-width: 400px; border: 1px solid var(--border); }
.tabs { display: flex; gap: 10px; margin-bottom: 10px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
.tab { padding: 8px 16px; border-radius: 8px; cursor: pointer; opacity: 0.6; background: #0f172a; border: 1px solid var(--border); }
.tab.active { opacity: 1; border-color: var(--primary); color: var(--primary); }
@media(max-width:640px){ #chat{height:320px} }
</style>
</head>
<body>
<div class="container">
<div class="card">
<div class="row" style="justify-content: space-between; margin-bottom: 10px;">
  <h2 style="margin:0">Secure Chat</h2>
  <button id="profileBtn" style="width: auto; padding: 6px 12px; display:none;" onclick="showProfile()">Profile</button>
</div>

<div id="loginBox">
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div id="adminPanel" style="display:none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
  <h3>Admin Dashboard</h3>
  <div class="row">
    <input id="newUser" placeholder="New username">
    <input id="newPass" type="password" placeholder="Password">
    <button onclick="createUser()" style="width: auto;">Create</button>
  </div>
  <p><b>User Management</b></p>
  <div id="userList" style="display: grid; gap: 8px;"></div>
</div>

<div id="chatUI" style="display:none">
  <div class="row" style="margin-bottom: 10px;">
    <span>Logged in as <b id="me" style="color: var(--primary);"></b></span>
    <span id="presenceCount" class="badge"></span>
  </div>
  
  <div class="tabs">
    <div class="tab active" onclick="switchTab('global')">Global Chat</div>
    <div class="tab" onclick="switchTab('friends')">Friends & Requests</div>
  </div>

  <div id="online" style="margin-bottom: 10px; padding: 8px; background: #0f172a; border-radius: 8px; font-size: 13px;"></div>

  <div id="friendsView" style="display:none; margin-bottom: 15px;">
    <div class="row">
      <input id="userSearch" placeholder="Search users by name...">
      <button onclick="searchUsers()" style="width: auto;">Search</button>
    </div>
    <div id="searchResults" style="margin-top: 5px;"></div>
    
    <div id="requestSection" style="display:none; border-top: 1px solid var(--border); margin-top: 10px; padding-top: 10px;">
      <p><b>Friend Requests</b></p>
      <div id="requestsList" style="display: grid; gap: 8px;"></div>
    </div>

    <p><b>My Friends</b></p>
    <div id="friendsList" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
  </div>

  <select id="room" onchange="loadMessages()" style="margin-bottom: 10px;">
    <option value="global">Global Room</option>
  </select>

  <div id="chat"></div>
  <div id="typing" class="small" style="height: 20px; color: var(--primary);"></div>
  <div class="row">
    <textarea id="msg" placeholder="Type message..."></textarea>
    <button onclick="sendMessage()" style="width: 100px; height: 60px;">Send</button>
  </div>
</div>
</div>
</div>

<div id="profileModal" class="modal">
  <div class="modal-content">
    <h3>Update Profile</h3>
    <input id="updUser" placeholder="New Username">
    <input id="updPass" type="password" placeholder="New Password">
    <button onclick="updateProfile()">Save Changes</button>
    <button onclick="closeProfile()" style="background: #475569; margin-top: 10px;">Cancel</button>
  </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const socket = io();
let user = null;
let currentTab = 'global';
let friendsListGlobal = [];

function switchTab(t) {
  currentTab = t;
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  const tabEl = document.querySelector(`.tab[onclick="switchTab('${t}')"]`);
  if (tabEl) tabEl.classList.add('active');
  
  if (t === 'friends') {
    friendsView.style.display = 'block';
    loadFriends();
    loadRequests();
  } else {
    friendsView.style.display = 'none';
    room.value = 'global';
    loadMessages();
  }
}

function login() {
  fetch("/api/login", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ username: username.value, password: password.value })
  }).then(r=>r.json()).then(d=>{
    if(d.error){ alert(d.error); return; }
    user = d;
    me.textContent = d.username;
    loginBox.style.display="none";
    chatUI.style.display="block";
    profileBtn.style.display="block";
    if(d.role === "admin"){
      adminPanel.style.display="block";
      loadUsers();
    }
    socket.emit("join", user);
    socket.emit("joinRoom","global");
    loadFriends().then(() => {
        loadMessages();
        loadRequests();
    });
  });
}

function loadMessages(){
  chat.innerHTML = "";
  const selected = room.value;
  if (!user) return;
  fetch(`/api/messages?userId=${user.id}`)
    .then(r => r.json())
    .then(msgs => {
      msgs.forEach(m => {
        if (selected === 'global') {
          if (!m.receiver_id && m.room === 'global') renderMessage(m);
        } else {
          const friendId = parseInt(selected);
          // Private chat logic: (me -> friend) OR (friend -> me)
          if ((m.receiver_id === friendId && m.sender_id === user.id) || 
              (m.receiver_id === user.id && m.sender_id === friendId)) {
            renderMessage(m);
          }
        }
      });
    });
}

function renderMessage(m){
  const d = document.createElement("div");
  d.className="msg";
  d.innerHTML = `
    <div style="display:flex; justify-content: space-between;">
      <b style="color: var(--primary)">${m.from}</b>
      <span class="small">${new Date(m.timestamp).toLocaleTimeString()}</span>
    </div>
    <div style="margin-top: 4px; white-space: pre-wrap;">${m.text}</div>
  `;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

socket.on("presence", list=>{
  if (!user) return;
  const activeFriends = list.filter(u => friendsListGlobal.some(f => f.id === u.id));
  
  if (user.role === 'admin') {
    online.innerHTML = "<b>All Active Users:</b> " + list.map(u => u.username).join(", ");
    presenceCount.textContent = list.length + " active users";
  } else {
    online.innerHTML = "<b>Online Friends:</b> " + (activeFriends.length > 0 ? activeFriends.map(u => u.username).join(", ") : "None");
    presenceCount.textContent = activeFriends.length + " friends online";
  }
});

const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

msg.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    if (isMobile) return;
    if (!e.shiftKey) { e.preventDefault(); sendMessage(); }
  }
});

msg.addEventListener("input", ()=>{
  if (user) socket.emit("typing", room.value, user.username);
});

socket.on("typing", u=>{
  typing.textContent = `${u} is typing...`;
  clearTimeout(window.typingTimer);
  window.typingTimer = setTimeout(()=> typing.textContent="", 2000);
});

socket.on("message", (m) => {
  const selected = room.value;
  if (selected === 'global' && !m.receiver_id && m.room === 'global') {
    renderMessage(m);
  } else if (selected !== 'global') {
     const friendId = parseInt(selected);
     if ((m.receiver_id === friendId && m.sender_id === user.id) || 
         (m.receiver_id === user.id && m.sender_id === friendId)) {
       renderMessage(m);
     }
  }
});

function sendMessage(){
  const text = msg.value.trim();
  if(!text || !user) return;
  const isPrivate = room.value !== 'global';
  const payload = { from: user.username, room: isPrivate ? null : 'global', text: text, receiverId: isPrivate ? parseInt(room.value) : null };
  socket.emit("message", payload);
  msg.value="";
}

function searchUsers() {
  const q = userSearch.value.trim();
  if (!q) return;
  fetch("/api/users/search", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query: q, currentUserId: user.id })
  }).then(r => r.json()).then(list => {
    searchResults.innerHTML = "";
    list.forEach(u => {
      const div = document.createElement("div");
      div.className = "row";
      const btnText = user.role === 'admin' ? "Message Directly" : "Add Friend";
      const action = user.role === 'admin' ? `startDirectChat(${u.id}, '${u.username}')` : `sendRequest(${u.id})`;
      div.innerHTML = `<span>${u.username}</span><button onclick="${action}" style="width:auto">${btnText}</button>`;
      searchResults.appendChild(div);
    });
  });
}

function startDirectChat(id, username) {
  // Ensure the friend appears in the dropdown/list for the admin immediately
  if (!friendsListGlobal.some(f => f.id === id)) {
    friendsListGlobal.push({ id, username });
    updateFriendsUI();
  }
  room.value = id;
  loadMessages();
}

function updateFriendsUI() {
  friendsList.innerHTML = "";
  const current = room.value;
  room.innerHTML = '<option value="global">Global Room</option>';
  friendsListGlobal.forEach(f => {
    const btn = document.createElement("button");
    btn.textContent = f.username;
    btn.style.width = "auto";
    btn.style.background = "#475569";
    btn.onclick = () => { room.value = f.id; loadMessages(); };
    friendsList.appendChild(btn);

    const opt = document.createElement("option");
    opt.value = f.id;
    opt.textContent = `Chat with ${f.username}`;
    room.appendChild(opt);
  });
  if (current && Array.from(room.options).some(o => o.value === current)) {
      room.value = current;
  } else {
      room.value = 'global';
  }
}

function sendRequest(id) {
  fetch("/api/friends/request", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId: user.id, friendId: id })
  }).then(() => {
    alert("Request sent!");
    searchResults.innerHTML = "";
    userSearch.value = "";
  });
}

function loadRequests() {
  if (!user) return;
  fetch(`/api/friends/requests/${user.id}`)
    .then(r => r.json())
    .then(list => {
      requestsList.innerHTML = "";
      requestSection.style.display = list.length > 0 ? "block" : "none";
      list.forEach(r => {
        const div = document.createElement("div");
        div.className = "row";
        div.style.background = "#0f172a";
        div.style.padding = "8px";
        div.style.borderRadius = "8px";
        div.innerHTML = `<span style="flex:1">${r.username}</span><button onclick="acceptRequest(${r.id})" style="width:auto; padding: 4px 10px;">Accept</button>`;
        requestsList.appendChild(div);
      });
    });
}

function acceptRequest(id) {
  fetch("/api/friends/accept", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId: user.id, friendId: id })
  }).then(() => {
    loadRequests();
    loadFriends();
  });
}

function loadFriends() {
  if (!user) return Promise.resolve();
  return fetch(`/api/friends/${user.id}`)
    .then(r => r.json())
    .then(list => {
      // Automatically add Admin to the list if the user is not admin
      if (user.role !== 'admin') {
        const adminExists = list.some(f => f.username === 'admin');
        if (!adminExists) {
          // Add virtual admin friend
          list.push({ id: 1, username: 'admin' }); // Admin ID is 1
        }
      }
      
      friendsListGlobal = list;
      friendsList.innerHTML = "";
      const current = room.value;
      room.innerHTML = '<option value="global">Global Room</option>';
      list.forEach(f => {
        const btn = document.createElement("button");
        btn.textContent = f.username;
        btn.style.width = "auto";
        btn.style.background = "#475569";
        btn.onclick = () => { room.value = f.id; loadMessages(); };
        friendsList.appendChild(btn);

        const opt = document.createElement("option");
        opt.value = f.id;
        opt.textContent = `Chat with ${f.username}`;
        room.appendChild(opt);
      });
      if (current && Array.from(room.options).some(o => o.value === current)) {
          room.value = current;
      } else {
          room.value = 'global';
      }
    });
}

function createUser(){
  fetch("/api/admin/users", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ adminUser:"admin", adminPass:"admin123", username:newUser.value, password:newPass.value })
  }).then(r=>r.json()).then(d=>{
    if(d.error){ alert(d.error); return; }
    loadUsers();
    newUser.value="";
    newPass.value="";
  });
}

function loadUsers(){
  fetch("/api/admin/list-users", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ adminUser:"admin", adminPass:"admin123" })
  }).then(r=>r.json()).then(list=>{
    userList.innerHTML="";
    list.forEach(u=>{
      const div=document.createElement("div");
      div.className = "row";
      div.style.background = "#0f172a";
      div.style.padding = "10px";
      div.style.borderRadius = "8px";
      div.innerHTML = `
        <span style="flex:1">${u.username} (${u.role})</span>
        ${u.username !== "admin" ? `<button onclick="deleteUser('${u.username}')" style="width: auto; background: #ef4444; padding: 4px 10px;">Delete</button>` : ""}
      `;
      userList.appendChild(div);
    });
  });
}

function deleteUser(username) {
  if (!confirm(`Delete user ${username}?`)) return;
  fetch("/api/admin/delete-user", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ adminUser: "admin", adminPass: "admin123", username })
  }).then(r => r.json()).then(d => {
    if (d.error) alert(d.error);
    else loadUsers();
  });
}

function showProfile() { if (user) { updUser.value = user.username; profileModal.style.display = "flex"; } }
function closeProfile() { profileModal.style.display = "none"; }
function updateProfile() {
  fetch("/api/user/update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ currentUsername: user.username, newUsername: updUser.value, newPassword: updPass.value })
  }).then(r => r.json()).then(d => {
    if (d.error) alert(d.error);
    else { alert("Profile updated!"); user.username = updUser.value; me.textContent = user.username; closeProfile(); }
  });
}
</script>
</body>
</html>
